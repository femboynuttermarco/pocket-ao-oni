<script>
const stats = { hunger:100, health:100, fun:100 };
function updateBars() {
  ['hunger','health','fun'].forEach(s=>{
    const b=document.getElementById(s+'-bar');
    b.style.width=stats[s]+'%';
    b.style.backgroundColor=stats[s]>60?'green':stats[s]>30?'orange':'red';
  });
}
updateBars();

const canvas = document.getElementById('pet-canvas');
const ctx = canvas.getContext('2d');
let originalImageData, currentImageData;

const petImage = new Image();
petImage.crossOrigin = "anonymous";
petImage.src = "https://th.bing.com/th/id/OIP.LuohQanTX6FMimfo2B000wAAAA?w=115&h=180&c=7&r=0&o=7&dpr=1.3&pid=1.7&rm=3";
petImage.onload = () => {
  ctx.drawImage(petImage,0,0,canvas.width,canvas.height);
  originalImageData = ctx.getImageData(0,0,canvas.width,canvas.height);
  currentImageData = ctx.getImageData(0,0,canvas.width,canvas.height);
};

const showerItems = document.getElementById('shower-items');
const kitchenItems = document.getElementById('kitchen-items');
const gamesRoom = document.getElementById('games-room');

function showRoom(room) {
  showerItems.style.display='none';
  kitchenItems.style.display='none';
  gamesRoom.style.display='none';
  canvas.style.display='block'; // ✅ show pet by default
  stopAllGames(); // ✅ stop any running games

  if(room==='shower'){showerItems.style.display='flex';}
  if(room==='kitchen'){kitchenItems.style.display='flex';generateKitchenItems();}
  if(room==='games'){
    gamesRoom.style.display='flex';
    canvas.style.display='none'; // ✅ hide pet during games
    startRandomGame();
  }
}

document.getElementById('btn-shower').onclick=()=>showRoom('shower');
document.getElementById('btn-kitchen').onclick=()=>showRoom('kitchen');
document.getElementById('btn-games').onclick=()=>showRoom('games');

// soap & shower
let draggingItem=null;
document.getElementById('soap').ondragstart=()=>{draggingItem='soap';};
document.getElementById('soap').ondragend=()=>{draggingItem=null;};
document.getElementById('shower').ondragstart=()=>{draggingItem='shower';};
document.getElementById('shower').ondragend=()=>{draggingItem=null;};

canvas.addEventListener('dragover',e=>{
  e.preventDefault();
  if(!draggingItem)return;
  const rect=canvas.getBoundingClientRect();
  const x=Math.floor(e.clientX-rect.left);
  const y=Math.floor(e.clientY-rect.top);
  if(draggingItem==='soap'){paintSoap(x,y);}
  if(draggingItem==='shower'){paintShower(x,y);}
});
function getIndex(x,y,w){return(y*w+x)*4;}
function paintSoap(cx,cy){
  if(!currentImageData)return;
  const r=15,d=currentImageData.data;
  for(let y=Math.max(0,cy-r);y<Math.min(canvas.height,cy+r);y++){
    for(let x=Math.max(0,cx-r);x<Math.min(canvas.width,cx+r);x++){
      const dx=x-cx,dy=y-cy;if(dx*dx+dy*dy<=r*r){
        const i=getIndex(x,y,canvas.width);
        d[i]=Math.min(255,d[i]+15);
        d[i+1]=Math.min(255,d[i+1]+15);
        d[i+2]=Math.min(255,d[i+2]+15);
      }
    }
  }
  ctx.putImageData(currentImageData,0,0);
}
function approach(c,t,s){if(c<t)return Math.min(c+s,t);if(c>t)return Math.max(c-s,t);return c;}
function paintShower(cx,cy){
  if(!currentImageData)return;
  const r=15,cd=currentImageData.data,od=originalImageData.data;
  let heal=false;
  for(let y=Math.max(0,cy-r);y<Math.min(canvas.height,cy+r);y++){
    for(let x=Math.max(0,cx-r);x<Math.min(canvas.width,cx+r);x++){
      const dx=x-cx,dy=y-cy;if(dx*dx+dy*dy<=r*r){
        const i=getIndex(x,y,canvas.width);
        cd[i]=approach(cd[i],od[i],15);
        cd[i+1]=approach(cd[i+1],od[i+1],15);
        cd[i+2]=approach(cd[i+2],od[i+2],15);
        heal=true;
      }
    }
  }
  ctx.putImageData(currentImageData,0,0);
  if(heal){stats.health=Math.min(100,stats.health+0.5);updateBars();}
}

// Kitchen
const kitchenFood=["🍞","🥞","🧇","🍖","🍗","🍕"];
const kitchenBad=["🪨","⌛","👓","🕶️","🥽","🧤"];
let kitchenDragging=null;

function generateKitchenItems(){
  kitchenItems.innerHTML='';
  const f=[...kitchenFood].sort(()=>0.5-Math.random()).slice(0,3);
  f.forEach(x=>{
    const el=document.createElement('div');el.textContent=x;el.className='drag-item';el.draggable=true;el.dataset.type='food';
    el.ondragstart=e=>{kitchenDragging=el;};el.ondragend=e=>{kitchenDragging=null;};
    kitchenItems.appendChild(el);
  });
  const b=[...kitchenBad].sort(()=>0.5-Math.random()).slice(0,2);
  b.forEach(x=>{
    const el=document.createElement('div');el.textContent=x;el.className='drag-item';el.draggable=true;el.dataset.type='bad';
    el.ondragstart=e=>{kitchenDragging=el;};el.ondragend=e=>{kitchenDragging=null;};
    kitchenItems.appendChild(el);
  });
}

canvas.addEventListener('drop',e=>{
  e.preventDefault();
  if(!kitchenDragging)return;
  if(kitchenDragging.dataset.type==='food'){stats.hunger=Math.min(100,stats.hunger+15);}
  if(kitchenDragging.dataset.type==='bad'){stats.hunger=Math.max(0,stats.hunger-15);}
  updateBars();
  kitchenDragging=null;
});

setInterval(()=>{stats.hunger=Math.max(0,stats.hunger-0.1);stats.health=Math.max(0,stats.health-0.05);stats.fun=Math.max(0,stats.fun-0.05);updateBars();},1000);

// Games
let gameTimerInterval;
let currentAnim = null; // ✅ track animation
let spawnInterval = null; // ✅ track spawns

function stopAllGames(){
  clearInterval(gameTimerInterval);
  if (currentAnim) cancelAnimationFrame(currentAnim);
  if (spawnInterval) clearInterval(spawnInterval);
  window.onkeydown = null;
}

function startRandomGame(){
  document.getElementById('game1-container').style.display='none';
  document.getElementById('game2-container').style.display='none';
  document.getElementById('game3-container').style.display='none';
  stopAllGames(); // ✅ stop previous game
  const g = Math.floor(Math.random()*3)+1;
  if(g===1){startGame1();}
  if(g===2){startGame2();}
  if(g===3){startGame3();}
}

function startTimer(sec){
  let remain=sec;
  const bar=document.getElementById('game-timer-bar');
  clearInterval(gameTimerInterval);
  gameTimerInterval=setInterval(()=>{
    remain--;
    bar.style.width=(remain/sec*100)+'%';
    if(remain<=0){
      clearInterval(gameTimerInterval);
      alert('Time up!');
      showRoom('shower'); // ✅ return to shower after game
    }
  },1000);
}

// Game 1
const game1Images=[
  "https://via.placeholder.com/80?text=A",
  "https://via.placeholder.com/80?text=B",
  "https://via.placeholder.com/80?text=C"
];
function startGame1(){
  document.getElementById('game1-container').style.display='flex';
  startTimer(20);
  const top=document.getElementById('game1-top');
  const bottom=document.getElementById('game1-bottom');
  top.innerHTML='';bottom.innerHTML='';
  game1Images.forEach(url=>{
    let img=document.createElement('img');img.src=url;top.appendChild(img);
  });
  [...game1Images].sort(()=>0.5-Math.random()).forEach(url=>{
    let img=document.createElement('img');img.src=url;img.draggable=true;bottom.appendChild(img);
  });
}

// Game 2
function startGame2(){
  document.getElementById('game2-container').style.display='flex';
  startTimer(30);
  const c=document.getElementById('flappy-canvas');
  const ctx2=c.getContext('2d');
  let birdY=200,birdV=0,score=0,pipes=[];
  const birdImg=new Image();
  birdImg.src="https://th.bing.com/th/id/OIP.oKYgUpp8slI7na6Uxab7NQHaHa?w=181&h=183&c=7&r=0&o=5&dpr=1.3&pid=1.7";
  function loop(){
    ctx2.clearRect(0,0,c.width,c.height);
    birdV+=0.5; birdY+=birdV;
    if(birdY>c.height-40){alert("Game Over!");showRoom('shower');return;}
    ctx2.drawImage(birdImg,50,birdY,40,40);
    if(pipes.length<3 || pipes[pipes.length-1].x<200){pipes.push({x:c.width,gapY:Math.random()*200+50});}
    for(let p of pipes){
      p.x-=2;
      ctx2.fillStyle='green';
      ctx2.fillRect(p.x,0,50,p.gapY-50);
      ctx2.fillRect(p.x,p.gapY+50,50,c.height-p.gapY-50);
      if(50<p.x+50&&50+40>p.x&&(birdY<p.gapY-50||birdY+40>p.gapY+50)){alert("Game Over!");showRoom('shower');return;}
      if(p.x+50<50&&!p.passed){p.passed=true;score++;if(score>=5){alert("You win!");showRoom('shower');return;}}
    }
    currentAnim=requestAnimationFrame(loop);
  }
  window.onkeydown=()=>{birdV=-7;};
  loop();
}

// Game 3
function startGame3(){
  document.getElementById('game3-container').style.display='flex';
  startTimer(30);
  const c=document.getElementById('catch-canvas');
  const ctx3=c.getContext('2d');
  let petX=150,score=0;
  let items=[];
  function spawn(){items.push({x:Math.random()*260,y:0,e:[...kitchenFood,...kitchenBad][Math.floor(Math.random()* (kitchenFood.length+kitchenBad.length))]});}
  spawnInterval=setInterval(spawn,800);
  function loop(){
    ctx3.clearRect(0,0,c.width,c.height);
    ctx3.fillStyle='blue';ctx3.fillRect(petX,360,40,40);
    items.forEach(it=>{
      ctx3.font='30px serif';ctx3.fillText(it.e,it.x,it.y);
      it.y+=3;
      if(it.y>340 && it.x>petX-20 && it.x<petX+40){
        if(kitchenFood.includes(it.e)){score++;document.getElementById('catch-score').textContent=score;if(score>=10){alert("You win!");showRoom('shower');return;}}
        if(kitchenBad.includes(it.e)){alert("Bad item!");showRoom('shower');return;}
      }
    });
    currentAnim=requestAnimationFrame(loop);
  }
  window.onkeydown=e=>{
    if(e.key==='ArrowLeft'){petX=Math.max(0,petX-20);}
    if(e.key==='ArrowRight'){petX=Math.min(260,petX+20);}
  };
  loop();
}
</script>
