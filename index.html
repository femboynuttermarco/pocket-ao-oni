<script>
// ---- STATS ----
const stats = { hunger:100, health:100, fun:100 };
function updateBars() {
  ['hunger','health','fun'].forEach(s=>{
    const b=document.getElementById(s+'-bar');
    if(!b) return;
    b.style.width = stats[s]+'%';
    b.style.backgroundColor = stats[s]>60?'green':stats[s]>30?'orange':'red';
  });
}
updateBars();

// ---- PET CANVAS ----
const canvas = document.getElementById('pet-canvas');
const ctx = canvas.getContext('2d');
let originalImageData, currentImageData;

const petImage = new Image();
petImage.crossOrigin = "anonymous";
petImage.src = "https://th.bing.com/th/id/OIP.LuohQanTX6FMimfo2B000wAAAA?w=115&h=180&c=7&r=0&o=7&dpr=1.3&pid=1.7&rm=3";
petImage.onload = () => {
  ctx.drawImage(petImage,0,0,canvas.width,canvas.height);
  originalImageData = ctx.getImageData(0,0,canvas.width,canvas.height);
  currentImageData = ctx.getImageData(0,0,canvas.width,canvas.height);
};

// ---- ROOM CONTAINERS ----
const showerItems = document.getElementById('shower-items');
const kitchenItems = document.getElementById('kitchen-items');
const gamesRoom   = document.getElementById('games-room');

// ---- HIDE/SHOW ----
function hideAll() {
  showerItems.style.display = 'none';
  kitchenItems.style.display = 'none';
  gamesRoom.style.display = 'none';
  canvas.style.display = 'block';
  stopAllGames();
}
document.getElementById('btn-shower').onclick = ()=>{ hideAll(); showerItems.style.display='flex'; };
document.getElementById('btn-kitchen').onclick= ()=>{ hideAll(); kitchenItems.style.display='flex'; generateKitchenItems(); };
document.getElementById('btn-games').onclick  = ()=>{ hideAll(); canvas.style.display='none'; gamesRoom.style.display='flex'; startRandomGame(); };

// ---- SHOWER DRAGGING ----
let draggingItem=null;
document.getElementById('soap').ondragstart=()=>{draggingItem='soap';};
document.getElementById('shower').ondragstart=()=>{draggingItem='shower';};
document.getElementById('soap').ondragend=()=>{draggingItem=null;};
document.getElementById('shower').ondragend=()=>{draggingItem=null;};

canvas.addEventListener('dragover',e=>{
  e.preventDefault();
  if(!draggingItem)return;
  const rect=canvas.getBoundingClientRect();
  const x=Math.floor(e.clientX-rect.left);
  const y=Math.floor(e.clientY-rect.top);
  if(draggingItem==='soap') paintSoap(x,y);
  if(draggingItem==='shower') paintShower(x,y);
});
function getIndex(x,y,w){return(y*w+x)*4;}
function paintSoap(cx,cy){
  if(!currentImageData)return;
  const r=15,d=currentImageData.data;
  for(let y=Math.max(0,cy-r);y<Math.min(canvas.height,cy+r);y++){
    for(let x=Math.max(0,cx-r);x<Math.min(canvas.width,cx+r);x++){
      const dx=x-cx,dy=y-cy;
      if(dx*dx+dy*dy<=r*r){
        const i=getIndex(x,y,canvas.width);
        d[i]=Math.min(255,d[i]+15);
        d[i+1]=Math.min(255,d[i+1]+15);
        d[i+2]=Math.min(255,d[i+2]+15);
      }
    }
  }
  ctx.putImageData(currentImageData,0,0);
}
function approach(c,t,s){if(c<t)return Math.min(c+s,t);if(c>t)return Math.max(c-s,t);return c;}
function paintShower(cx,cy){
  if(!currentImageData)return;
  const r=15,cd=currentImageData.data,od=originalImageData.data;
  let heal=false;
  for(let y=Math.max(0,cy-r);y<Math.min(canvas.height,cy+r);y++){
    for(let x=Math.max(0,cx-r);x<Math.min(canvas.width,cx+r);x++){
      const dx=x-cx,dy=y-cy;
      if(dx*dx+dy*dy<=r*r){
        const i=getIndex(x,y,canvas.width);
        cd[i]=approach(cd[i],od[i],15);
        cd[i+1]=approach(cd[i+1],od[i+1],15);
        cd[i+2]=approach(cd[i+2],od[i+2],15);
        heal=true;
      }
    }
  }
  ctx.putImageData(currentImageData,0,0);
  if(heal){ stats.health=Math.min(100,stats.health+0.5); updateBars(); }
}

// ---- KITCHEN ----
const kitchenFood=["🍞","🥞","🧇","🍖","🍗","🍕"];
const kitchenBad=["🪨","⌛","👓","🕶️","🥽","🧤"];
let kitchenDragging=null;

function generateKitchenItems(){
  kitchenItems.innerHTML='';
  [...kitchenFood].sort(()=>0.5-Math.random()).slice(0,3).forEach(e=>{
    const el=document.createElement('div');el.className='drag-item';el.textContent=e;el.draggable=true;el.dataset.type='food';
    el.ondragstart=()=>{kitchenDragging=el;};el.ondragend=()=>{kitchenDragging=null;};
    kitchenItems.appendChild(el);
  });
  [...kitchenBad].sort(()=>0.5-Math.random()).slice(0,2).forEach(e=>{
    const el=document.createElement('div');el.className='drag-item';el.textContent=e;el.draggable=true;el.dataset.type='bad';
    el.ondragstart=()=>{kitchenDragging=el;};el.ondragend=()=>{kitchenDragging=null;};
    kitchenItems.appendChild(el);
  });
}
canvas.addEventListener('drop',e=>{
  e.preventDefault();
  if(!kitchenDragging)return;
  if(kitchenDragging.dataset.type==='food'){ stats.hunger=Math.min(100,stats.hunger+15); }
  else { stats.hunger=Math.max(0,stats.hunger-15); }
  updateBars(); kitchenDragging=null;
});

// ---- DECAY ----
setInterval(()=>{
  stats.hunger=Math.max(0,stats.hunger-0.1);
  stats.health=Math.max(0,stats.health-0.05);
  stats.fun=Math.max(0,stats.fun-0.05);
  updateBars();
},1000);

// ---- GAMES ----
let activeIntervals=[];
function stopAllGames(){
  activeIntervals.forEach(id=>clearInterval(id));
  activeIntervals=[];
  ['game1-container','game2-container','game3-container'].forEach(id=>{
    const el=document.getElementById(id);
    if(el) el.style.display='none';
  });
}
function startRandomGame(){
  stopAllGames();
  const g=Math.floor(Math.random()*3)+1;
  if(g===1) startGame1();
  if(g===2) startGame2();
  if(g===3) startGame3();
}

// Example simple Game1 (drag matching)
function startGame1(){
  document.getElementById('game1-container').style.display='flex';
}

// Example simple Game2 (flappy placeholder)
function startGame2(){
  document.getElementById('game2-container').style.display='flex';
}

// Example simple Game3 (catch placeholder)
function startGame3(){
  document.getElementById('game3-container').style.display='flex';
}
</script>
