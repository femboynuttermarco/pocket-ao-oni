<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Pet Game Fixed</title>
<style>
  body {
    margin:0; padding:0;
    font-family: Arial, sans-serif;
    user-select:none;
    overflow:hidden;
  }
  #top-bar {
    position:fixed; top:10px; right:10px;
    background:rgba(255,255,255,0.95);
    padding:10px; border-radius:10px; width:200px;
    box-shadow:0 0 6px rgba(0,0,0,0.1);
    z-index:10;
  }
  .stat { margin-bottom:10px; }
  .stat-label { font-weight:bold; }
  .stat-bar-bg {
    background:#ccc; height:14px; border-radius:7px;
    margin-top:4px; overflow:hidden;
  }
  .stat-bar {
    height:14px; border-radius:7px; width:100%;
    background:green; transition:width 0.3s, background-color 0.3s;
  }
  #buttons {
    position:fixed; top:10px; left:10px;
    display:flex; gap:10px; z-index:10;
  }
  #buttons button { padding:8px 14px; font-size:14px; cursor:pointer; }

  #room {
    margin:60px auto 10px auto;
    position:relative;
    width:800px;
    height:400px;
    border:1px solid #aaa;
    border-radius:10px;
    background:#f9f9f9;
    overflow:hidden;
  }
  #pet-canvas {
    position:absolute;
    left:0; top:0;
    width:200px; height:200px;
    border:1px solid #aaa;
    border-radius:10px;
    margin:10px;
    z-index:1;
  }
  #shower-items, #kitchen-items, #games-room {
    position:absolute;
    left:220px; top:0;
    width:560px; height:100%;
    display:none;
    justify-content:center;
    align-items:center;
    gap:30px;
    font-size:40px;
    overflow:hidden;
  }
  .drag-item { cursor:grab; transition:opacity 0.2s; }
  .drag-item.dragging { opacity:0.5; }

  #kitchen-items { flex-wrap:wrap; font-size:50px; gap:20px; }
  #games-room { flex-direction:column; font-size:20px; align-items:center; }

  #game1-container, #game2-container, #game3-container { display:none; flex-direction:column; align-items:center; }
  .game-images-row {
    display:flex; gap:10px; margin:10px;
  }
  .game-images-row img {
    width:80px; height:80px; border:1px solid #444; border-radius:8px; cursor:grab;
  }
  #game-timer-bar-bg {
    background:#ccc; height:14px; width:300px; border-radius:7px;
    overflow:hidden; margin-bottom:10px;
  }
  #game-timer-bar {
    height:14px; width:100%; background:blue; border-radius:7px; transition:width 0.2s linear;
  }
</style>
</head>
<body>
<div id="top-bar">
  <div class="stat"><div class="stat-label">Hunger</div><div class="stat-bar-bg"><div id="hunger-bar" class="stat-bar"></div></div></div>
  <div class="stat"><div class="stat-label">Health</div><div class="stat-bar-bg"><div id="health-bar" class="stat-bar"></div></div></div>
  <div class="stat"><div class="stat-label">Fun</div><div class="stat-bar-bg"><div id="fun-bar" class="stat-bar"></div></div></div>
</div>

<div id="buttons">
  <button id="btn-shower">Shower</button>
  <button id="btn-kitchen">Kitchen</button>
  <button id="btn-games">Games</button>
</div>

<div id="room">
  <canvas id="pet-canvas" width="200" height="200"></canvas>
  <div id="shower-items">
    <div id="soap" class="drag-item" draggable="true">ðŸ§¼</div>
    <div id="shower" class="drag-item" draggable="true">ðŸš¿</div>
  </div>
  <div id="kitchen-items"></div>
  <div id="games-room">
    <div id="game-timer-bar-bg"><div id="game-timer-bar"></div></div>
    <div id="game1-container">
      <div class="game-images-row" id="game1-top"></div>
      <div class="game-images-row" id="game1-bottom"></div>
    </div>
    <div id="game2-container">
      <canvas id="flappy-canvas" width="300" height="300" style="border:1px solid #000;"></canvas>
    </div>
    <div id="game3-container">
      <canvas id="catch-canvas" width="300" height="300" style="border:1px solid #000;"></canvas>
      <div>Score: <span id="catch-score">0</span></div>
    </div>
  </div>
</div>

<script>
const stats = { hunger:100, health:100, fun:100 };
function updateBars() {
  ['hunger','health','fun'].forEach(s=>{
    const b=document.getElementById(s+'-bar');
    b.style.width=stats[s]+'%';
    b.style.backgroundColor=stats[s]>60?'green':stats[s]>30?'orange':'red';
  });
}
updateBars();

// Draw pet
const canvas = document.getElementById('pet-canvas');
const ctx = canvas.getContext('2d');
let originalImageData, currentImageData;
const petImage = new Image();
petImage.crossOrigin = "anonymous";
petImage.src = "https://th.bing.com/th/id/OIP.LuohQanTX6FMimfo2B000wAAAA?w=115&h=180&c=7&r=0&o=7&dpr=1.3&pid=1.7&rm=3";
petImage.onload = () => {
  ctx.drawImage(petImage,0,0,canvas.width,canvas.height);
  originalImageData = ctx.getImageData(0,0,canvas.width,canvas.height);
  currentImageData = ctx.getImageData(0,0,canvas.width,canvas.height);
};

// room switching
const showerItems = document.getElementById('shower-items');
const kitchenItems = document.getElementById('kitchen-items');
const gamesRoom = document.getElementById('games-room');
function hideAll(){
  showerItems.style.display='none';
  kitchenItems.style.display='none';
  gamesRoom.style.display='none';
  stopCurrentGame();
}
function showRoom(r){
  hideAll();
  if(r==='shower')showerItems.style.display='flex';
  if(r==='kitchen'){kitchenItems.style.display='flex';generateKitchenItems();}
  if(r==='games'){gamesRoom.style.display='flex';startRandomGame();}
}
document.getElementById('btn-shower').onclick=()=>showRoom('shower');
document.getElementById('btn-kitchen').onclick=()=>showRoom('kitchen');
document.getElementById('btn-games').onclick=()=>showRoom('games');

// shower painting
let draggingItem=null;
document.getElementById('soap').ondragstart=()=>{draggingItem='soap';};
document.getElementById('soap').ondragend=()=>{draggingItem=null;};
document.getElementById('shower').ondragstart=()=>{draggingItem='shower';};
document.getElementById('shower').ondragend=()=>{draggingItem=null;};
canvas.addEventListener('dragover',e=>{
  e.preventDefault();
  if(!draggingItem)return;
  const rect=canvas.getBoundingClientRect();
  const x=Math.floor(e.clientX-rect.left);
  const y=Math.floor(e.clientY-rect.top);
  if(draggingItem==='soap'){paintSoap(x,y);}
  if(draggingItem==='shower'){paintShower(x,y);}
});
function getIndex(x,y,w){return(y*w+x)*4;}
function paintSoap(cx,cy){
  if(!currentImageData)return;
  const r=15,d=currentImageData.data;
  for(let y=Math.max(0,cy-r);y<Math.min(canvas.height,cy+r);y++){
    for(let x=Math.max(0,cx-r);x<Math.min(canvas.width,cx+r);x++){
      const dx=x-cx,dy=y-cy;if(dx*dx+dy*dy<=r*r){
        const i=getIndex(x,y,canvas.width);
        d[i]=Math.min(255,d[i]+15);
        d[i+1]=Math.min(255,d[i+1]+15);
        d[i+2]=Math.min(255,d[i+2]+15);
      }
    }
  }
  ctx.putImageData(currentImageData,0,0);
}
function approach(c,t,s){if(c<t)return Math.min(c+s,t);if(c>t)return Math.max(c-s,t);return c;}
function paintShower(cx,cy){
  if(!currentImageData)return;
  const r=15,cd=currentImageData.data,od=originalImageData.data;
  let heal=false;
  for(let y=Math.max(0,cy-r);y<Math.min(canvas.height,cy+r);y++){
    for(let x=Math.max(0,cx-r);x<Math.min(canvas.width,cx+r);x++){
      const dx=x-cx,dy=y-cy;if(dx*dx+dy*dy<=r*r){
        const i=getIndex(x,y,canvas.width);
        cd[i]=approach(cd[i],od[i],15);
        cd[i+1]=approach(cd[i+1],od[i+1],15);
        cd[i+2]=approach(cd[i+2],od[i+2],15);
        heal=true;
      }
    }
  }
  ctx.putImageData(currentImageData,0,0);
  if(heal){stats.health=Math.min(100,stats.health+0.5);updateBars();}
}

// kitchen
const kitchenFood=["ðŸž","ðŸ¥ž","ðŸ§‡","ðŸ–","ðŸ—","ðŸ•"];
const kitchenBad=["ðŸª¨","âŒ›","ðŸ‘“","ðŸ•¶ï¸","ðŸ¥½","ðŸ§¤"];
let kitchenDragging=null;
function generateKitchenItems(){
  kitchenItems.innerHTML='';
  [...kitchenFood].sort(()=>0.5-Math.random()).slice(0,3).forEach(x=>{
    const el=document.createElement('div');
    el.textContent=x;el.className='drag-item';el.draggable=true;el.dataset.type='food';
    el.ondragstart=()=>{kitchenDragging=el;};el.ondragend=()=>{kitchenDragging=null;};
    kitchenItems.appendChild(el);
  });
  [...kitchenBad].sort(()=>0.5-Math.random()).slice(0,2).forEach(x=>{
    const el=document.createElement('div');
    el.textContent=x;el.className='drag-item';el.draggable=true;el.dataset.type='bad';
    el.ondragstart=()=>{kitchenDragging=el;};el.ondragend=()=>{kitchenDragging=null;};
    kitchenItems.appendChild(el);
  });
}
canvas.addEventListener('drop',e=>{
  e.preventDefault();
  if(!kitchenDragging)return;
  if(kitchenDragging.dataset.type==='food'){stats.hunger=Math.min(100,stats.hunger+15);}
  if(kitchenDragging.dataset.type==='bad'){stats.hunger=Math.max(0,stats.hunger-15);}
  updateBars();
  kitchenDragging=null;
});
setInterval(()=>{
  stats.hunger=Math.max(0,stats.hunger-0.1);
  stats.health=Math.max(0,stats.health-0.05);
  stats.fun=Math.max(0,stats.fun-0.05);
  updateBars();
},1000);

// games
let currentGame=null;
let gameTimerInterval=null;
let stopGameLoop=null;

function stopCurrentGame(){
  if(gameTimerInterval){clearInterval(gameTimerInterval);gameTimerInterval=null;}
  if(stopGameLoop){stopGameLoop();stopGameLoop=null;}
  document.getElementById('game1-container').style.display='none';
  document.getElementById('game2-container').style.display='none';
  document.getElementById('game3-container').style.display='none';
}

function startRandomGame(){
  stopCurrentGame();
  const g=Math.floor(Math.random()*3)+1;
  if(g===1){startGame1();}
  else if(g===2){startGame2();}
  else{startGame3();}
}

const game1Images=["https://via.placeholder.com/80?text=A","https://via.placeholder.com/80?text=B","https://via.placeholder.com/80?text=C"];
function startGame1(){
  currentGame=1;
  document.getElementById('game1-container').style.display='flex';
  startTimer(30);
  const top=document.getElementById('game1-top');
  const bottom=document.getElementById('game1-bottom');
  top.innerHTML=''; bottom.innerHTML='';
  // top random order
  game1Images.sort(()=>0.5-Math.random()).forEach(src=>{
    const img=document.createElement('img');
    img.src=src; img.draggable=true;
    img.ondragstart=e=>{
      e.dataTransfer.setData('text/plain',src);
    };
    top.appendChild(img);
  });
  // bottom placeholders
  game1Images.forEach(_=>{
    const img=document.createElement('img');
    img.dataset.drop=true;
    img.style.backgroundColor='#eee';
    img.addEventListener('dragover',e=>e.preventDefault());
    img.addEventListener('drop',e=>{
      e.preventDefault();
      const data=e.dataTransfer.getData('text/plain');
      if(data){
        img.src=data;
        // check correctness
        const correct = game1Images.indexOf(data) === Array.from(bottom.children).indexOf(img);
        if(correct){stats.fun=Math.min(100,stats.fun+5);} else {stats.fun=Math.max(0,stats.fun-3);}
        updateBars();
      }
    });
    bottom.appendChild(img);
  });
}

function startTimer(seconds){
  const bar=document.getElementById('game-timer-bar');
  let time=seconds;
  bar.style.width='100%';
  gameTimerInterval=setInterval(()=>{
    time-=0.1;
    if(time<=0){
      clearInterval(gameTimerInterval);
      gameTimerInterval=null;
      stopCurrentGame();
      stats.fun=Math.max(0,stats.fun-10);
      updateBars();
    }
    else{
      bar.style.width=(time/seconds*100)+'%';
    }
  },100);
}

function startGame2(){
  currentGame=2;
  document.getElementById('game2-container').style.display='flex';
  startTimer(20);
  const fCanvas=document.getElementById('flappy-canvas');
  const fCtx=fCanvas.getContext('2d');

  // Flappy bird simplified
  let bird={x:50,y:150,vy:0};
  const gravity=0.5;
  const jump=-8;
  let pipes=[];
  let frame=0;
  let gameOver=false;

  function createPipe(){
    const height=Math.random()*150+50;
    pipes.push({x:300,y:0,height});
    pipes.push({x:300,y:height+100,height:300-height-100});
  }
  function reset(){
    bird={x:50,y:150,vy:0};
    pipes=[];
    frame=0;
    gameOver=false;
  }
  reset();

  function loop(){
    if(gameOver) return;
    frame++;
    if(frame%90===0) createPipe();
    bird.vy+=gravity;
    bird.y+=bird.vy;
    // collision
    if(bird.y>280||bird.y<0){
      gameOver=true;
      stats.fun=Math.max(0,stats.fun-10);
      updateBars();
      stopCurrentGame();
      return;
    }
    pipes.forEach(p=>{
      p.x-=2;
      if(p.x+50>bird.x && p.x<bird.x+30){
        if(bird.y<p.height && p.y===0) gameOver=true;
        if(bird.y>p.height && p.y!==0) gameOver=true;
      }
    });
    pipes=pipes.filter(p=>p.x>-50);

    if(gameOver){
      stats.fun=Math.max(0,stats.fun-10);
      updateBars();
      stopCurrentGame();
      return;
    }
    fCtx.clearRect(0,0,300,300);
    fCtx.fillStyle='skyblue';
    fCtx.fillRect(0,0,300,300);
    fCtx.fillStyle='green';
    pipes.forEach(p=>{
      fCtx.fillRect(p.x,p.y,50,p.height);
    });
    fCtx.fillStyle='yellow';
    fCtx.beginPath();
    fCtx.ellipse(bird.x,bird.y,15,12,0,0,Math.PI*2);
    fCtx.fill();

    requestAnimationFrame(loop);
  }
  fCanvas.onclick=()=>{
    if(!gameOver) bird.vy=jump;
  };
  loop();
}

function startGame3(){
  currentGame=3;
  document.getElementById('game3-container').style.display='flex';
  startTimer(25);
  const cCanvas=document.getElementById('catch-canvas');
  const cCtx=cCanvas.getContext('2d');
  let score=0;
  let objects=[];
  let gameOver=false;
  let playerX=150;

  function reset(){
    score=0;objects=[];gameOver=false;playerX=150;
  }
  reset();

  function spawnObject(){
    objects.push({x:Math.random()*280,y:0,vy:2+Math.random()*3});
  }

  function loop(){
    if(gameOver) return;
    cCtx.clearRect(0,0,300,300);
    // draw player
    cCtx.fillStyle='purple';
    cCtx.fillRect(playerX,270,30,30);
    // move objects
    objects.forEach(o=>{
      o.y+=o.vy;
      cCtx.fillStyle='red';
      cCtx.beginPath();
      cCtx.arc(o.x,o.y,10,0,Math.PI*2);
      cCtx.fill();
    });
    // collision
    objects=objects.filter(o=>{
      if(o.y>300) return false;
      if(o.y>270 && o.x>playerX && o.x<(playerX+30)){
        score++;
        stats.fun=Math.min(100,stats.fun+3);
        updateBars();
        return false;
      }
      return true;
    });

    cCtx.fillStyle='black';
    cCtx.font='16px Arial';
    cCtx.fillText('Score: '+score,10,20);

    if(Math.random()<0.02) spawnObject();

    requestAnimationFrame(loop);
  }
  cCanvas.onmousemove=e=>{
    const rect=cCanvas.getBoundingClientRect();
    playerX=e.clientX-rect.left-15;
    if(playerX<0)playerX=0;
    if(playerX>270)playerX=270;
  };
  loop();
}
</script>
</body>
</html>
